name: CI
on: 
  push: 
    push: [ *refresh ]
    paths-ignore: 
      - '**.md'
      - '**.txt'
      - '.github/**'
      - '!.github/workflows/**'
  pull_request: 
    branches: [ main*, *prerelease, *prod ]

jobs:
  setup:
    name: Setup Project Info
    runs-on: ubuntu-latest
    outputs: 
      DIST_SUFFIX: ${{ steps.get-suffix.outputs.DIST_SUFFIX }}

    steps: 
     - name: ğŸ§ Checkout
       id: checkout
       uses: actions/checkout@v3
       with: 
         fetch-depth: '0'

     - name: ğŸ“™ Get Package Suffix
       id: get-suffix
       run: |
         TAG_NAME=$(git describe --abbrev=0 --tags)
         BUILD_TIME=$(date "+%y%m%d-%H%M")
         HEAD_BRANCH=$(git symbolic-ref --short -q HEAD)
         HEAD_SHA=$(git rev-parse --short HEAD)
         HEAD_SHA_SHORT=${HEAD_SHA:0:4}
         echo "DIST_SUFFIX=${TAG_NAME}.${HEAD_SHA_SHORT}.${HEAD_BRANCH}.${BUILD_TIME}" >> $GITHUB_OUTPUT


  build: 
    name: Build Production Pages
    needs: setup
    env: 
      DIST_NAME: dist-${{ needs.setup.outputs.DIST_SUFFIX }}
    runs-on: ubuntu-latest
    steps: 
     - name: ğŸ§ Checkout
       id: checkout
       uses: actions/checkout@v3

     - name: ğŸ”§ Setup NodeJS
       id: setup_node
       uses: actions/setup-node@v3
       with: 
         node-version: latest

     - name: ğŸ”§ Setup Yarn
       id: setup_yarn
       run: |
         npm install yarn -g
         yarn set version berry
     
     - name: ğŸš§ Setup dependencies
       id: setup_deps
       run: |
         yarn add @vue/cli
         yarn install

     - name: âš™ï¸ Build production pages
       id: build
       run: |
         yarn build
 
     - name: ğŸ“¦ Pack the build
       id: pack
       run: |
         sudo apt-get install zip
         zip -r ${{ env.DIST_NAME }}.zip dist
 
     - name: ğŸŒ Upload the build
       id: upload
       uses: actions/upload-artifact@v3
       with: 
         name: ${{ env.DIST_NAME }}
         path: ${{ env.DIST_NAME }}.zip

