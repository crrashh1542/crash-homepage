name: CI

on: 
  push: 
    branches: [ canary, dev-v2 ]
    paths-ignore: 
      - '**.md'
      - '**.txt'
      - '.github/**'
      - '!.github/workflows/**'
  pull_request: 
    branches: [ dev-v2, v2 ]

jobs:
  setup:
    name: Setup Project Info
    runs-on: ubuntu-latest
    outputs: 
      DIST_SUFFIX: ${{ steps.get-suffix.outputs.DIST_SUFFIX }}

    steps: 
     - name: ğŸ§ Checkout
       id: checkout
       uses: actions/checkout@v3

     - name: ğŸ“™ Get Package Suffix
       id: get-suffix
       run: |
         TAG_NAME=$(git describe --abbrev=0 --tags)
         BUILD_DATE=$(date "+%Y%m%d")
         HEAD_SHA=$(git rev-parse --short HEAD)
         echo "::set-output name=DIST_SUFFIX::${TAG_NAME}-${BUILD_DATE}-${HEAD_SHA}"


  build: 
    name: Build Production Pages
    needs: setup
    env: 
      DIST_NAME: dist-${{ needs.setup.outputs.DIST_SUFFIX }}
    runs-on: ubuntu-latest
    steps: 
     - name: ğŸ§ Checkout
       id: checkout
       uses: actions/checkout@v3

     - name: ğŸ”§ Setup pnpm
       id: setup_pnpm
       uses: pnpm/action-setup@v2
       with: 
         version: latest

     - name: ğŸš§ Setup dependencies
       id: setup_deps
       run: |
         pnpm install @vue/cli -g
         pnpm install

     - name: âš™ï¸ Build production pages
       id: build
       run: |
         pnpm build
 
     - name: ğŸ“¦ Pack the build
       id: pack
       run: |
         sudo apt-get install zip
         zip -r ${{ env.DIST_NAME }}.zip dist
 
     - name: ğŸŒ Upload the build
       id: upload
       uses: actions/upload-artifact@v3
       with: 
         name: ${{ env.DIST_NAME }}
         path: ${{ env.DIST_NAME }}.zip

